str(essall2)
?scale
scale(c(0,0,0,1,1,0,9))
scale(c(0,0,0,1,1,0,9),scale=T)
scale(c(0,0,0,1,1,0,9),scale=T)[,1]
essall2<-essall %>%
left_join(.,immsalm,by=c("cntry","wave7")) %>%
mutate(eduyrs=as.numeric(eduyrs),
yrfac=factor(ifelse(wave7==0,"Wave 1","Wave 7"))) %>%
filter(!(cntry %in% c("IL"))) %>% #remove israel, huge outlier
mutate(zcultshare=scale(cultshare)[,1])
#ranef
summary(re1<-lmer(eparltrust~eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=subset(essall2,cntry!="DK")))
#fixef
summary(fe1<-lm(eparltrust~eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2<-lm(eparltrust~eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
stargazer(re1,re2,fe1,fe2,omit="cntry",style="apsr",type="text")
prdat<-data.frame(expand.grid(eduyrs=13,lrscale=.5,zcultshare=c(-.5,5),imtkjobs=seq(from=0,to=1,by=.05),cntry="NL",yrfac="Wave 1"))
preds<-predict(fe1,newdata=prdat,se.fit=T)
preds
prdat$fit<-preds$fit
prdat$se<-preds$se.fit
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~zcultshare)
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~zcultshare) +
theme_bw()
prdat
prdat<-data.frame(expand.grid(eduyrs=13,lrscale=.5,zcultshare=c(-.5,5),imtkjobs=seq(from=0,to=1,by=.05),cntry="NL",yrfac="Wave 1"))
preds<-predict(fe1,newdata=prdat,se.fit=T)
prdat<-prdat %>%
mutate(fit=preds$fit,se=preds$se.fit,
immsal=factor(ifelse(zcultshare==5,"Highest","Immigration salience: Lowest")))
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~immsal) +
theme_bw()
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~reorder(immsal,zcultshare)) +
theme_bw()
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~immsal) +
theme_bw()
prdat$immsal
reorder(prdat$immsal,prdat$zcultshare)
prdsat$immsal<-reorder(prdat$immsal,prdat$zcultshare)
prdat$immsal<-reorder(prdat$immsal,prdat$zcultshare)
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU")
ggplot(prdat,aes(x=imtkjobs,y=fit,ymin=fit-2*se,ymax=fit+2*se)) +
geom_line() +
geom_ribbon(alpha=.2) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU") +
scale_x_continuous(breaks=c(0,.5,1),labels=c("0",".5","1"))
ggplot(prdat,aes(x=imtkjobs,y=fit)) +
geom_line() +
geom_ribbon(aes(ymin=fit-1.96*se,ymax=fit+1.96*se),alpha=.15) +
geom_ribbon(aes(ymin=fit-1.65*se,ymax=fit+1.65*se),alpha=.15) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU") +
scale_x_continuous(breaks=c(0,.5,1),labels=c("0",".5","1"))
essall2<-essall %>%
left_join(.,immsalm,by=c("cntry","wave7")) %>%
mutate(eduyrs=as.numeric(eduyrs),
yrfac=factor(ifelse(wave7==0,"Wave 1","Wave 7"))) %>%
filter(!(cntry %in% c("IL"))) %>% #remove israel, huge outlier
mutate(zcultshare=scale(cultshare)[,1],
zncsahre=scale(natcultshare)[,1])
essall2<-essall %>%
left_join(.,immsalm,by=c("cntry","wave7")) %>%
mutate(eduyrs=as.numeric(eduyrs),
yrfac=factor(ifelse(wave7==0,"Wave 1","Wave 7"))) %>%
filter(!(cntry %in% c("IL"))) %>% #remove israel, huge outlier
mutate(zcultshare=scale(cultshare)[,1],
zncshare=scale(natcultshare)[,1])
summary(rex<-lmer(eparltrust~eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(rex<-lmer(eparltrust~eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(fe1x<-lm(eparltrust~eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2x<-lm(eparltrust~eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
require(readr)
require(haven)
require(dplyr)
require(magrittr)
require(broom)
require(ggplot2)
require(manifestoR)
require(countrycode)
require(lubridate)
require(reshape2)
require(lme4)
require(stargazer)
#load ess 1 and 7
ess1<-read_spss("/Users/frederikhjorth/Dropbox/Data/ESS1/ESS1.sav")
ess7<-read_stata("/Users/frederikhjorth/Dropbox/Data/ESS7/ESS7e01.dta")
str(ess1)
#countries in both waves
cntrylist<-intersect(names(table(ess1$cntry)),names(table(ess7$cntry)))
cntryunion<-union(names(table(ess1$cntry)),names(table(ess7$cntry)))
ess7r<-ess7 %>%
transmute(imtkjobs=ifelse(imtcjob<11,(imtcjob-10)/-10,NA),
lrscale=ifelse(lrscale<11,lrscale/10,NA),
eparltrust=ifelse(trstep<11,trstep/10,NA),
female=ifelse(gndr<3,gndr-1,NA),
age=ifelse(agea<999,agea,NA),
eduyrs=eduyrs,
wave7=1,
cntry=cntry)
ess1r<-ess1 %>%
transmute(imtkjobs=ifelse(imtcjob<11,(imtcjob-10)/-10,NA),
lrscale=ifelse(lrscale<11,lrscale/10,NA),
eparltrust=ifelse(trstep<11,trstep/10,NA),
female=ifelse(gndr<3,gndr-1,NA),
age=ifelse(agea<999,agea,NA),
eduyrs=eduyrs,
wave7=0,
cntry=cntry)
essall<-bind_rows(ess7r,ess1r)
# #data frame for storing estimates
# cntryests<-data.frame(cntry=rep(cntrylist,each=3),model=rep(c("wave1","wave7","change"),14),est=NA,se=NA)
#
# for (cntryname in cntrylist){
#   #estimate models
#   w1m<-lm(eparltrust~lrscale+imtkjobs,data=subset(essall,wave7==0 & cntry==cntryname))
#   w7m<-lm(eparltrust~lrscale+imtkjobs,data=subset(essall,wave7==1 & cntry==cntryname))
#   chgm<-lm(eparltrust~lrscale+wave7*imtkjobs,data=subset(essall,cntry==cntryname))
#   #store estimates
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="wave1",3:4]<-tidy(w1m)[3,2:3]
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="wave7",3:4]<-tidy(w7m)[3,2:3]
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="change",3:4]<-tidy(chgm)[5,2:3]
# }
#
# ggplot(cntryests,aes(x=cntry,y=est)) +
#   geom_point() +
#   geom_errorbar(aes(ymin=est-2*se,ymax=est+2*se),width=0) +
#   geom_hline(yintercept=0,linetype="dashed") +
#   theme_bw() +
#   facet_grid(model~.)
#
# xm<-lm(eparltrust~lrscale+wave7*imtkjobs,data=subset(essall,cntry=="DK"))
# tidy(xm)
# tidy(w1m)[3,2:3]
#set api key for cmp data
mp_setapikey(key="97ae2911cb3f94b74ccceea5678f92a6")
#get cmp data
cmpdf<-mp_maindataset()
#get list for merging country names
countrymerger<-data.frame(countryname=unique(cmpdf$countryname),cntry=countrycode(unique(cmpdf$countryname),origin="country.name",destination="iso2c"))
#merge in country codes
cmpdf2<-cmpdf %>%
left_join(.,countrymerger,by="countryname") %>%
#  filter(cntry %in% cntrylist) %>%
mutate(year=year(ymd(edate))) %>%
select(countryname,cntry,year,per601,per602,per607,per608,total) %>%
mutate(nat=per601+per602,
cult=per607+per608)
cmpdf3<-cmpdf2 %>%
group_by(cntry,year) %>%
summarise(natsum=sum(nat),cultsum=sum(cult),totsum=sum(total)) %>%
mutate(natshare=natsum/totsum,
cultshare=cultsum/totsum,
natcultshare=(natsum+cultsum)/totsum)
#create data frame for merging back into ess
immsal<-data.frame(cntry=cntryunion)
immsal
#get last int year for each country
immsal<-ess1 %>%
group_by(cntry) %>%
summarise(minyearw1=min(inwyr,na.rm=T)) %>%
left_join(immsal,.,by="cntry")
immsal<-ess7 %>%
group_by(cntry) %>%
summarise(minyearw7=min(inwyye,na.rm=T)) %>%
left_join(immsal,.,by="cntry")
#fill out years
immsal$minyearw1[is.na(immsal$minyearw1)]<-2002
immsal$minyearw7[is.na(immsal$minyearw7)]<-2014
immsal
immsalm<-immsal %>%
melt(id.vars="cntry") %>%
transmute(cntry=cntry,ivyear=value,wave7=ifelse(variable=="minyearw7",1,0))
#get last election year before ess
immsalm$year<-NA
for (i in 1:nrow(immsalm)){
elecyrs<-unique(subset(cmpdf3,cntry==immsalm$cntry[i])$year)
preelecyr<-max(elecyrs[elecyrs<immsalm$ivyear[i]])
immsalm$year[i]<-preelecyr
}
immsalm<-immsalm %>%
left_join(.,cmpdf3,by=c("cntry","year"))
essall2<-essall %>%
left_join(.,immsalm,by=c("cntry","wave7")) %>%
mutate(eduyrs=as.numeric(eduyrs),
yrfac=factor(ifelse(wave7==0,"Wave 1","Wave 7"))) %>%
filter(!(cntry %in% c("IL"))) %>% #remove israel, huge outlier
mutate(zcultshare=scale(cultshare)[,1],
zncshare=scale(natcultshare)[,1])
#ranef
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=subset(essall2,cntry!="DK")))
summary(rex<-lmer(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
#fixef
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
stargazer(re1,re2,fe1,fe2,omit="cntry",style="apsr",type="text")
?quantile
quantile(essall2$zcultshare,props=c(.05,.95))
quantile(essall2$zcultshare,props=c(.05,.95),na.rm=T)
quantile(essall2$zcultshare,probs=c(.05,.95),na.rm=T)
prdat<-data.frame(expand.grid(eduyrs=13,lrscale=.5,
zcultshare=quantile(essall2$zcultshare,probs=c(.05,.95),na.rm=T),
imtkjobs=seq(from=0,to=1,by=.05),cntry="NL",yrfac="Wave 1"))
preds<-predict(fe1,newdata=prdat,se.fit=T)
prdat<-prdat %>%
mutate(fit=preds$fit,se=preds$se.fit,
immsal=factor(ifelse(zcultshare==5,"Highest","Immigration salience: Lowest")))
prdat$immsal<-reorder(prdat$immsal,prdat$zcultshare)
ggplot(prdat,aes(x=imtkjobs,y=fit)) +
geom_line() +
geom_ribbon(aes(ymin=fit-1.96*se,ymax=fit+1.96*se),alpha=.15) +
geom_ribbon(aes(ymin=fit-1.65*se,ymax=fit+1.65*se),alpha=.15) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU") +
scale_x_continuous(breaks=c(0,.5,1),labels=c("0",".5","1"))
prdat
prdat<-data.frame(expand.grid(eduyrs=13,lrscale=.5,
zcultshare=quantile(essall2$zcultshare,probs=c(.05,.95),na.rm=T),
imtkjobs=seq(from=0,to=1,by=.05),cntry="NL",yrfac="Wave 1"))
preds<-predict(fe1,newdata=prdat,se.fit=T)
prdat<-prdat %>%
mutate(fit=preds$fit,se=preds$se.fit,
immsal=factor(ifelse(zcultshare>2,"Highest","Immigration salience: Lowest")))
prdat$immsal<-reorder(prdat$immsal,prdat$zcultshare)
ggplot(prdat,aes(x=imtkjobs,y=fit)) +
geom_line() +
geom_ribbon(aes(ymin=fit-1.96*se,ymax=fit+1.96*se),alpha=.15) +
geom_ribbon(aes(ymin=fit-1.65*se,ymax=fit+1.65*se),alpha=.15) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU") +
scale_x_continuous(breaks=c(0,.5,1),labels=c("0",".5","1"))
summary(essall2)
prdat<-data.frame(expand.grid(female=1,age=47,eduyrs=13,lrscale=.5,
zcultshare=quantile(essall2$zcultshare,probs=c(.05,.95),na.rm=T),
imtkjobs=seq(from=0,to=1,by=.05),cntry="NL",yrfac="Wave 1"))
preds<-predict(fe1,newdata=prdat,se.fit=T)
prdat<-prdat %>%
mutate(fit=preds$fit,se=preds$se.fit,
immsal=factor(ifelse(zcultshare>2,"Highest","Immigration salience: Lowest")))
prdat$immsal<-reorder(prdat$immsal,prdat$zcultshare)
ggplot(prdat,aes(x=imtkjobs,y=fit)) +
geom_line() +
geom_ribbon(aes(ymin=fit-1.96*se,ymax=fit+1.96*se),alpha=.15) +
geom_ribbon(aes(ymin=fit-1.65*se,ymax=fit+1.65*se),alpha=.15) +
facet_grid(.~immsal) +
theme_bw() +
labs(x="Anti-immigration attitude",y="Trust in EU") +
scale_x_continuous(breaks=c(0,.5,1),labels=c("0",".5","1"))
stargazer(re1,re2,fe1,fe2,omit="cntry",style="apsr",type="text")
summary(fe1<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
#ranef
summary(re0<-lmer(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=subset(essall2,cntry!="DK")))
summary(rex<-lmer(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
#fixef
summary(fe0<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,cntry!="DK")))
stargazer(re0,re1,re2,fe0,fe1,fe2,omit="cntry",style="apsr",type="text")
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+zcultshare*yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
stargazer(re0,re1,re2,fe0,fe1,fe2,omit=c("cntry","zcultshare:cn"),style="apsr",type="text")
View(immsalm)
summary(immsalm$ivyear-immsalm$year)
summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
summary(fe2<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
#ranef
summary(re0<-lmer(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=essall2))
summary(re3<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=subset(essall2,cntry!="DK")))
summary(rex<-lmer(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
#fixef
summary(fe0<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
summary(fe2<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
# summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
# summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
stargazer(re0,re1,re2,re3,fe0,fe1,fe2,fe3,omit=c("cntry","zcultshare:cn"),style="apsr",type="text",omit.stat="f")
#ranef
summary(re0<-lmer(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=essall2))
summary(re3<-lmer(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=subset(essall2,!(cntry %in% c("DK","SE")))))
summary(rex<-lmer(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
#fixef
summary(fe0<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
summary(fe3<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
# summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
# summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
stargazer(re0,re1,re2,re3,fe0,fe1,fe2,fe3,omit=c("cntry","zcultshare:cn"),style="apsr",type="text",omit.stat="f")
stargazer(re0,re1,re2,re3,fe0,fe1,fe2,fe3,omit=c("cntry","zcultshare:cn","yrfac"),style="apsr",type="text",omit.stat="f")
table(ess1$polintr)
table(ess7$polintr)
require(readr)
require(haven)
require(dplyr)
require(magrittr)
require(broom)
require(ggplot2)
require(manifestoR)
require(countrycode)
require(lubridate)
require(reshape2)
require(lme4)
require(stargazer)
#load ess 1 and 7
ess1<-read_spss("/Users/frederikhjorth/Dropbox/Data/ESS1/ESS1.sav")
ess7<-read_stata("/Users/frederikhjorth/Dropbox/Data/ESS7/ESS7e01.dta")
str(ess1)
#countries in both waves
cntrylist<-intersect(names(table(ess1$cntry)),names(table(ess7$cntry)))
cntryunion<-union(names(table(ess1$cntry)),names(table(ess7$cntry)))
ess7r<-ess7 %>%
transmute(imtkjobs=ifelse(imtcjob<11,(imtcjob-10)/-10,NA),
lrscale=ifelse(lrscale<11,lrscale/10,NA),
polint=ifelse(polintr<5,(polintr-1)/3,NA),
eparltrust=ifelse(trstep<11,trstep/10,NA),
female=ifelse(gndr<3,gndr-1,NA),
age=ifelse(agea<999,agea,NA),
eduyrs=eduyrs,
wave7=1,
cntry=cntry)
ess1r<-ess1 %>%
transmute(imtkjobs=ifelse(imtcjob<11,(imtcjob-10)/-10,NA),
lrscale=ifelse(lrscale<11,lrscale/10,NA),
polint=ifelse(polintr<5,(polintr-1)/3,NA),
eparltrust=ifelse(trstep<11,trstep/10,NA),
female=ifelse(gndr<3,gndr-1,NA),
age=ifelse(agea<999,agea,NA),
eduyrs=eduyrs,
wave7=0,
cntry=cntry)
essall<-bind_rows(ess7r,ess1r)
# #data frame for storing estimates
# cntryests<-data.frame(cntry=rep(cntrylist,each=3),model=rep(c("wave1","wave7","change"),14),est=NA,se=NA)
#
# for (cntryname in cntrylist){
#   #estimate models
#   w1m<-lm(eparltrust~lrscale+imtkjobs,data=subset(essall,wave7==0 & cntry==cntryname))
#   w7m<-lm(eparltrust~lrscale+imtkjobs,data=subset(essall,wave7==1 & cntry==cntryname))
#   chgm<-lm(eparltrust~lrscale+wave7*imtkjobs,data=subset(essall,cntry==cntryname))
#   #store estimates
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="wave1",3:4]<-tidy(w1m)[3,2:3]
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="wave7",3:4]<-tidy(w7m)[3,2:3]
#   cntryests[cntryests$cntry==cntryname & cntryests$model=="change",3:4]<-tidy(chgm)[5,2:3]
# }
#
# ggplot(cntryests,aes(x=cntry,y=est)) +
#   geom_point() +
#   geom_errorbar(aes(ymin=est-2*se,ymax=est+2*se),width=0) +
#   geom_hline(yintercept=0,linetype="dashed") +
#   theme_bw() +
#   facet_grid(model~.)
#
# xm<-lm(eparltrust~lrscale+wave7*imtkjobs,data=subset(essall,cntry=="DK"))
# tidy(xm)
# tidy(w1m)[3,2:3]
#set api key for cmp data
mp_setapikey(key="97ae2911cb3f94b74ccceea5678f92a6")
#get cmp data
cmpdf<-mp_maindataset()
#get list for merging country names
countrymerger<-data.frame(countryname=unique(cmpdf$countryname),cntry=countrycode(unique(cmpdf$countryname),origin="country.name",destination="iso2c"))
#merge in country codes
cmpdf2<-cmpdf %>%
left_join(.,countrymerger,by="countryname") %>%
#  filter(cntry %in% cntrylist) %>%
mutate(year=year(ymd(edate))) %>%
select(countryname,cntry,year,per601,per602,per607,per608,total) %>%
mutate(nat=per601+per602,
cult=per607+per608)
cmpdf3<-cmpdf2 %>%
group_by(cntry,year) %>%
summarise(natsum=sum(nat),cultsum=sum(cult),totsum=sum(total)) %>%
mutate(natshare=natsum/totsum,
cultshare=cultsum/totsum,
natcultshare=(natsum+cultsum)/totsum)
#create data frame for merging back into ess
immsal<-data.frame(cntry=cntryunion)
immsal
#get last int year for each country
immsal<-ess1 %>%
group_by(cntry) %>%
summarise(minyearw1=min(inwyr,na.rm=T)) %>%
left_join(immsal,.,by="cntry")
immsal<-ess7 %>%
group_by(cntry) %>%
summarise(minyearw7=min(inwyye,na.rm=T)) %>%
left_join(immsal,.,by="cntry")
#fill out years
immsal$minyearw1[is.na(immsal$minyearw1)]<-2002
immsal$minyearw7[is.na(immsal$minyearw7)]<-2014
immsal
immsalm<-immsal %>%
melt(id.vars="cntry") %>%
transmute(cntry=cntry,ivyear=value,wave7=ifelse(variable=="minyearw7",1,0))
#get last election year before ess
immsalm$year<-NA
for (i in 1:nrow(immsalm)){
elecyrs<-unique(subset(cmpdf3,cntry==immsalm$cntry[i])$year)
preelecyr<-max(elecyrs[elecyrs<immsalm$ivyear[i]])
immsalm$year[i]<-preelecyr
}
immsalm<-immsalm %>%
left_join(.,cmpdf3,by=c("cntry","year"))
essall2<-essall %>%
left_join(.,immsalm,by=c("cntry","wave7")) %>%
mutate(eduyrs=as.numeric(eduyrs),
yrfac=factor(ifelse(wave7==0,"Wave 1","Wave 7"))) %>%
filter(!(cntry %in% c("IL"))) %>% #remove israel, huge outlier
mutate(zcultshare=scale(cultshare)[,1],
zncshare=scale(natcultshare)[,1])
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+polint+eduyrs+lrscale+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+polint*zcultshare*imtkjobs+cntry+yrfac,data=essall2))
#ranef
summary(re0<-lmer(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re1<-lmer(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
summary(re2<-lmer(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=essall2))
summary(re3<-lmer(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+(1+zcultshare|cntry)+(1|yrfac),data=subset(essall2,!(cntry %in% c("DK","SE")))))
summary(rex<-lmer(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+(1|cntry)+(1|yrfac),data=essall2))
#fixef
summary(fe0<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
summary(fe3<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
# summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
# summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
stargazer(re0,re1,re2,re3,fe0,fe1,fe2,fe3,omit=c("cntry","zcultshare:cn","yrfac"),style="apsr",type="text",omit.stat="f")
#fixef
summary(fe0<-lm(eparltrust~female+age+eduyrs+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe1<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+cntry+yrfac,data=essall2))
summary(fe2<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=essall2))
summary(fe3<-lm(eparltrust~female+age+eduyrs+lrscale+polint+zcultshare*imtkjobs+zcultshare*cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
# summary(fe1x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=essall2))
# summary(fe2x<-lm(eparltrust~female+age+eduyrs+lrscale+zncshare*imtkjobs+cntry+yrfac,data=subset(essall2,!(cntry %in% c("DK","SE")))))
stargazer(re0,re1,re2,re3,fe0,fe1,fe2,fe3,omit=c("cntry","zcultshare:cn","yrfac"),style="apsr",type="text",omit.stat="f")
require(readr)
nd<-read_delim("/Users/frederikhjorth/Downloads/allCountries.txt")
nd<-read_delim("/Users/frederikhjorth/Downloads/allCountries.txt",delim="\t")
str(nd)
names(nd)
names(nd)<-letters[1:19]
str(nd)
table(nd$i)
sqrt( ((.24)*(1-.24)) / 1000 )
sqrt( ((.5)*(1-.5)) / 1000 )
1.96*sqrt( ((.5)*(1-.5)) / 1000 )
1.96*sqrt( ((.24)*(1-.24)) / 1000 )
.24-1.96*sqrt( ((.24)*(1-.24)) / 1000 )
.24+1.96*sqrt( ((.24)*(1-.24)) / 1000 )
1.96*sqrt( ((.25)*(1-.25)) / 1000 )
sqrt( ((.25)*(1-.25)) / 1000 )
.25-1.96*sqrt( ((.25)*(1-.25)) / 1000 )
.25+1.96*sqrt( ((.25)*(1-.25)) / 1000 )
1.96*sqrt( ((.25)*(1-.25)) / 1000 )
require(lubridate)
require(dplyr)
require(magrittr)
require(ggplot2)
require(reshape2)
require(stargazer)
require(readr)
require(tidyr)
require(broom)
require(lme4)
require(arm)
require(rms)
require(mfx)
#win
#setwd("C:/Users/fh/Documents/GitHub/parlbias/data")
#mac
setwd("~/GitHub/parlbias/data")
ftall<-readRDS("ftall.rds")
